---
layout: post
title:  "PCIe闪存卡"
date:   2014-03-17 18:14:40
categories:  ubuntu 
tags:  ssd 性能测试
---

##特点:

-  比SSD读写性能更高、容量更大、寿命更长
-  体积更小、更省电
-  价格在可以接受范围


##牌子
最早做的是fusion-io, 价格偏高。国内现在也有厂家在做，我们选取了其中两家做测试,分别用M和S代表。

##对比
都需要安装内核模块驱动，M家提供源码编译安装；S家只提供二进制安装包，如果需要用在不同内核上，需要联系他们工程师。


测试步骤
---
#步骤一: 顺序将盘写满

```
time fio --name=seqWrite --filename=/dev/memdiska --numjobs=1 --bs=128k --ioengine=libaio --iodepth=32 --direct=1 --rw=write --group_reporting --randrepeat=0
```
```
写了2.4T,  写带宽 970MB/s, iops 7607, 延迟: ? 10ms or 90us
real    40m10.549s
user    30m40.964s
sys     9m32.036s
```
#步骤二:  执行随机读测试
```
fio --name=randRead --filename=/dev/memdiska --numjobs=1 --bs=4k --ioengine=sync --direct=1 --norandommap --rw=randread --group_reporting --randrepeat=0 --runtime=120
```

##测试结果:

 线程数/块大小| 4k | 16K | 64K
----|------|----|-----
1| 37MB/s;9266;  >250us(0.1%)  | 108MB/s;6759;>250us(0.6%) | 963MB/s;3763;>500us(0.56%)
4 | 146MB/s;36788;>250us(0.2%) | 456MB/s;28869;>250us(0.3%) | 2302MB/s;9200;>750us(0.6%) 
8| 253MB/s;66660;>250us(0.4%)  | 837MB/s;52315;>250us(1.32%) | 2794/s;11140;>1000us(1.53%)
16| 549MB/s;137252;>250us(0.2%) | 1458MB/s;93340;>250us(4.8%) | 3106MB/s;12426;>2000us(3.9%)
32| 862MB/s;215651;>250us(4.6%)| 2014MB/s;128936;>500us(2.3%) | 3261MB/s;13047;>4000us(4.4%)

#步骤二:  执行随机写测试(稳定态)
```
fio --name=precondition --filename=/dev/memdiska --numjobs=2 --bs=128k --ioengine=libaio --iodepth=32 --iodepth_batch=16 --iodepth_batch_complete=16 --direct=1 --rw=randwrite --group_reporting --randrepeat=0
```
随机写测试
```
fio --name=randomWrite --filename=/dev/memdiska --numjobs=1 --bs=4k --ioengine=sync --direct=1 --norandommap --rw=randwrite --group_reporting --randrepeat=0 --runtime=120
```
 线程数/块大小| 4k | 64K
----|------|----|-----
1| 114MB/s;29.4K  >50us(3%)  | 603MB/s;9.4K;>500us(0.38%) 
8|  588MB/s;147K;>250us(0.6%)  | 610MB/s;9.5K;>2000us(0.02%) 
16| 599MB/s;150K;>750us(0.3%) | 611MB/s;9549;>4000us(0.01%) 
32| 600MB/s;150k;>1000us(1.2%)| 610MB/s;9533;>10000us(0.01%) 

#步骤三:  执行随机混合读写测试(稳定态)
在步骤二基础上，

```
fio --name=randomReadWrite --filename=/dev/memdiska --numjobs=1 --bs=4k --ioengine=sync --direct=1 --norandommap --rw=randrw --rwmixread=70 --group_reporting --randrepeat=0 --runtime=120
```
读70%

线程数/块大小| 4k | 64K
----|------|----|-----
1| 28MB/s; 7K; avg:121us  | 101MB/s; 1.5K; avg:567us
8|  159MB/s; 40K;avg:177us  | 392MB/s; 6.1K; avg:1258us
16| 262MB/s;65K;avg:221us | 602MB/s; 9.4K; avg:2133us
32| 400MB/s;100k;avg:294us | 929MB/s; 14K; avg:121us

写30%

线程数/块大小| 4k | 64K
----|------|----|-----
1| 12MB/s; 3K; avg:36us  | 43MB/s; 0.67K; avg:100us
8|  68MB/s;17K; avg:41us | 168MB/s;2.6K;avg:93us
16| 112MB/s;28K;avg:40us | 258MB/s;4K;avg:105us
32| 171MB/s;43k;avg:45us| 398MB/s;6.2K;avg:146us

附录
---------
##附一:  M家驱动安装

安装依赖包

```
apt-get install make gcc g++ libncurses5-dev libncursesw5-dev
```
然后编译二进制

```
make
make install
```
遇到一个问题:
必须先安装上PCIe卡后，再执行make install。


##附二: fio安装

```
apt-get install libaio1 libaio-dev
```
下载[源码](http://freecode.com/projects/fio)，编译安装

##附三: 
http://benjr.tw/10842




